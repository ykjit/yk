<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Gotchas - Yk</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Yk</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="gotchas"><a class="header" href="#gotchas">Gotchas</a></h1>
<p>Yk has some unusual implications, requirements, and limitations that interpreter
authors should be aware of.</p>
<h2 id="trace-quality-depends-upon-completeness-of-interpreter-ir"><a class="header" href="#trace-quality-depends-upon-completeness-of-interpreter-ir">Trace quality depends upon completeness of interpreter IR.</a></h2>
<p>Yk works by recording traces (i.e. individual control flow paths) of your
interpreter's implementation. Each trace ends up as an ordered list of LLVM IR
blocks which are "stitched together" and compiled. Unless callees are marked
<code>yk_noinline</code>, the JIT will seek to inline them into the trace because,
generally speaking, the more the JIT can inline, the more optimal the JITted
code will be.</p>
<p>In order to inline a function call, the JIT needs to have LLVM IR for the
callee. Yk uses fat LTO to collect (and embed into the resulting binary) a
"full-program" IR for your interpreter. <code>yk-config</code> provides the relevant clang
flags to make this happen. You should make sure that the build system of your
interpreter uses the relevant flags. Namely <code>yk-config --cppflgs --cflags</code> for
compiling C code, and <code>yk-config --ldflags --libs</code> for linking.</p>
<p>It follows that shared objects, which at the time of writing cannot take part
in LTO, cannot be inlined into traces. If your interpreter <code>dlopen()</code>s shared
objects at runtime (as is common for C extensions) Yk will be unable to trace
the newly loaded code.</p>
<h2 id="symbol-visibility"><a class="header" href="#symbol-visibility">Symbol visibility</a></h2>
<p>The JIT relies upon the use of <code>dlsym()</code> at runtime in order to lookup any
given symbol from its virtual address. For this to work all symbols must be
exposed in the dynamic symbol table.</p>
<p><code>yk-config</code> provides flags to put every function's symbol into the dynamic
symbol table. Since distinct symbols of the same name can exist (e.g. <code>static</code>
functions in C), but dynamic symbol names must be unique, symbols may be
mangled (mangling is done by the fat LTO module merger). If your interpreter
does its own symbol introspection, Yk may break it.</p>
<h2 id="extra-sections-in-your-interpreter-binary"><a class="header" href="#extra-sections-in-your-interpreter-binary">Extra sections in your interpreter binary.</a></h2>
<p><code>yk-config</code> will add flags that add the following sections to your binary:</p>
<ul>
<li><code>.llvmbc</code>: LLVM bytecode for your interpreter. Used to construct traces.
This is a standard LLVM section (but extended by Yk).</li>
<li><code>.llvm_bb_addr_map</code>: The basic block address map. Used to map virtual
addresses back to LLVM IR blocks. This is a standard LLVM section (but
extended by Yk).</li>
<li><code>.llvm_stackmaps</code>: Stackmap table. Used to identify the locations of live
LLVM IR variables. This is a standard LLVM section (but extended by Yk).</li>
</ul>
<h2 id="other-interpreter-requirements-and-gotchas"><a class="header" href="#other-interpreter-requirements-and-gotchas">Other interpreter requirements and gotchas</a></h2>
<ul>
<li>
<p>Yk can only currently work with "simple interpreter loop"-style interpreters
and cannot yet handle unstructured interpreter loops (e.g. threaded
dispatch).</p>
</li>
<li>
<p>Yk currently assumes that no new code is loaded at runtime (e.g.
<code>dlopen()</code>), and that no code is unloaded (e.g. <code>dlclose()</code>). Self modifying
interpreters will also confuse the JIT.</p>
</li>
<li>
<p>Yk currently doesn't handle calls to <code>pthread_exit()</code> gracefully (<a href="https://github.com/ykjit/yk/issues/525">more
details</a>).</p>
</li>
<li>
<p>Yk currently doesn't handle <code>setjmp()</code>/<code>longjmp()</code>.</p>
</li>
<li>
<p>You cannot valgrind an interpreter that is using Intel PT for tracing (<a href="https://github.com/ykjit/yk/issues/177">more
details</a>).</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../dev/understanding_traces.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../internals/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../dev/understanding_traces.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../internals/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
